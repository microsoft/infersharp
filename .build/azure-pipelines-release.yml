name: "InferSharp-Release"

pool:
  vmImage: 'ubuntu-20.04'

steps:
- script: sudo apt-get update -y
  displayName: 'Initialize'

- script: ls
  displayName: 'Show files (TMP)'

- script: pwd
  displayName: 'Show current dir (TMP)'

- task: UseDotNet@2
  inputs:
    packageType: 'runtime'
    version: '5.x'

- task: Bash@3
  inputs:
    targetType: 'inline'
    script: 'dotnet build Infersharp.sln'

- task: Bash@3
  inputs:
    targetType: 'inline'
    script: './build_csharp_models.sh'

- task: Docker@2
  displayName: 'Build and test'
  enabled: false
  inputs:
    command: build

- script: ls
  displayName: 'Show files (TMP)'

- script: pwd
  displayName: 'Show current dir (TMP)'

- task: EsrpCodeSigning@1
  inputs:
    ConnectedServiceName: 'InferSharp ESRP CodeSigning'
    FolderPath: 'Cilsil/'
    Pattern: '*.dll,*.exe'
    signConfigType: 'inlineSignParams'
    inlineOperation: |
      [
        {
          "KeyCode" : "CP-401405",
          "OperationCode" : "NuGetSign",
          "Parameters" : {},
          "ToolName" : "sign",
          "ToolVersion" : "1.0"
        },
        {
          "KeyCode" : "CP-401405",
          "OperationCode" : "NuGetVerify",
          "Parameters" : {},
          "ToolName" : "sign",
          "ToolVersion" : "1.0"
        }
      ]
    SessionTimeout: '60'
    MaxConcurrency: '50'
    MaxRetryAttempts: '5'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop'
    publishLocation: 'Container'

